<script>
    // ... (Keep your manifest and service worker registration)

    const WEB_APP_URL = "YOUR_GOOGLE_SCRIPT_URL_HERE"; 
    const body = document.body;
    const statusDisplay = document.getElementById('status');
    const subStatus = document.getElementById('sub-status');
    const nameInput = document.getElementById('userName');
    const inputContainer = document.getElementById('input-container');
    const lockInfo = document.getElementById('lock-info');

    // --- RECOVERY LOGIC ---
    function rehydrateApp() {
        const savedName = localStorage.getItem('userName');
        const savedTag = localStorage.getItem('activeTag');

        if (savedName) {
            // Hide login, show tracker
            inputContainer.style.display = 'none';
            
            if (savedTag) {
                body.className = 'amber';
                statusDisplay.innerText = "Location Active";
                subStatus.innerText = "Logged at: " + savedTag;
            } else {
                body.className = '';
                statusDisplay.innerText = "Shift Active: " + savedName;
                subStatus.innerText = "Scan NFC to begin";
            }
            // Re-trigger hardware sensors
            startGlobalTracking();
            startNFC();
            requestWakeLock();
        }
    }

    // --- CRITICAL: WATCH FOR RESUME ---
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            console.log("App resumed. Rehydrating state...");
            rehydrateApp();
        }
    });

    // --- REPLACED INITIALIZE FUNCTION ---
    async function initShift(name) {
        localStorage.setItem('userName', name);
        rehydrateApp(); // Use the rehydrate function to set the UI
    }

    // --- UPDATED NFC LOGIC ---
    // Make sure to add this inside your NFC reader:
    // When CLOCK IN: localStorage.setItem('activeTag', currentId);
    // When CLOCK OUT: localStorage.removeItem('activeTag');

    window.onload = rehydrateApp; // Handle fresh loads
</script>
