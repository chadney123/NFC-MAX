<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw1zfywpTM4ALHBRuIgDRTX8X5uBfQbR4Y7yRgjTg9FGKgD8jU_tKIhdmHBvXYFr0G7/exec"; 
    
    const body = document.body;
    const statusDisplay = document.getElementById('status');
    const subStatus = document.getElementById('sub-status');
    const nameInput = document.getElementById('userName');
    const inputContainer = document.getElementById('input-container');
    const lockInfo = document.getElementById('lock-info');

    let activeTag = null; 
    let breadcrumbs = [];
    let gpsWatchId = null;
    let wakeLock = null;

    // --- 1. MAXIMUM ACCURACY GPS ---
    function startGlobalTracking() {
        if ("geolocation" in navigator) {
            gpsWatchId = navigator.geolocation.watchPosition((pos) => {
                const now = new Date();
                const totalMins = (now.getHours() * 60) + now.getMinutes();
                
                // Active Window Check
                if (totalMins >= 165 && totalMins < 480) {
                    // Accuracy check (lower = better). 30m is a safe 'high precision' threshold.
                    if (pos.coords.accuracy < 30) {
                        const pt = `${pos.coords.latitude.toFixed(6)},${pos.coords.longitude.toFixed(6)}`;
                        
                        // Log only if moved from last point
                        if (breadcrumbs[breadcrumbs.length - 1] !== pt) {
                            breadcrumbs.push(pt);
                            console.log("High-accuracy point recorded:", pt);
                        }
                    }
                }
            }, 
            (err) => console.warn("GPS Signal Lost: ", err), 
            { 
                enableHighAccuracy: true, // Force GPS hardware
                maximumAge: 0,           // Disable cache
                timeout: 5000            // Require fix every 5 seconds
            });
        }
    }

    // --- 2. DATA SYNC ---
    async function syncToSheet(tagText, action) {
        let mapLink = "N/A";
        if (action === "OUT" && breadcrumbs.length > 0) {
            // Standard static/dynamic path formatting
            mapLink = "https://www.google.com/maps/dir/" + breadcrumbs.join("/");
        }

        const payload = { 
            tagText: tagText, 
            name: nameInput.value, 
            action: action, 
            location: mapLink,
            timestamp: new Date().toISOString() 
        };

        fetch(WEB_APP_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    }

    // --- 3. NFC LOGIC ---
    async function startNFC() {
        if ("NDEFReader" in window) {
            const ndef = new NDEFReader();
            await ndef.scan();
            ndef.onreading = ({ message, serialNumber }) => {
                let chipText = "";
                const decoder = new TextDecoder();
                for (const record of message.records) {
                    if (record.recordType === "text") chipText = decoder.decode(record.data);
                }
                const currentId = chipText || serialNumber;

                if (!activeTag) {
                    activeTag = currentId;
                    body.classList.add('amber');
                    statusDisplay.innerText = "Location Active";
                    subStatus.innerText = "Logged at: " + currentId;
                    syncToSheet(currentId, "IN");
                } else if (activeTag === currentId) {
                    syncToSheet(currentId, "OUT");
                    activeTag = null;
                    breadcrumbs = []; // Reset for the next leg of the journey
                    body.classList.remove('amber');
                    statusDisplay.innerText = "Location Cleared";
                    subStatus.innerText = "Ready for next Location";
                    setTimeout(() => {
                        statusDisplay.innerText = "Shift in Progress";
                        subStatus.innerText = "Scan NFC to log";
                    }, 2500);
                }
            };
        }
    }

    // --- 4. PERSISTENT WAKE LOCK ---
    async function requestWakeLock() {
        try {
            wakeLock = await navigator.wakeLock.request('screen');
            lockInfo.innerText = "Wake Lock: Active | GPS: High Accuracy";
            
            // Re-request if app is minimized and reopened
            wakeLock.addEventListener('release', () => {
                console.log('Wake Lock was released');
            });
        } catch (err) {
            lockInfo.innerText = "Wake Lock: Failed";
        }
    }

    // Handle visibility change to keep GPS/WakeLock alive
    document.addEventListener('visibilitychange', async () => {
        if (wakeLock !== null && document.visibilityState === 'visible') {
            await requestWakeLock();
        }
    });

    // --- 5. INITIALIZE ---
    document.getElementById('startBtn').onclick = async () => { 
        const name = nameInput.value.trim();
        if(!name) return alert("Enter name");
        
        inputContainer.style.display = 'none';
        
        startGlobalTracking();
        try { 
            await startNFC(); 
            await requestWakeLock();
            statusDisplay.innerText = "Shift Active: " + name;
            subStatus.innerText = "NFC Scanner Ready";
        } catch (e) { 
            alert("Ensure Chrome on Android + HTTPS"); 
        }
    };

    function scheduleMorningReset() {
        const now = new Date();
        const resetTime = new Date();
        resetTime.setHours(8, 0, 0, 0);
        if (now > resetTime) resetTime.setDate(resetTime.getDate() + 1);
        setTimeout(() => { location.reload(); }, resetTime - now);
    }
    scheduleMorningReset();
</script>
